name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      CC: gcc
      CXX: g++
    steps:
    - uses: actions/checkout@v4

    - name: Restore ccache
      uses: actions/cache@v4
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('**/Makefile', '**/*.c', '**/*.cpp') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential autoconf automake libtool pkg-config cmake ccache

    - name: Ensure configure is executable
      run: |
        if [ -f ./configure ]; then
          chmod +x ./configure || true
        fi

    - name: Configure
      run: |
        if [ -f ./configure ]; then
          ./configure
        else
          echo "No configure script found; skipping configure step."
        fi

    - name: Build
      run: |
        if [ -f Makefile ]; then
          make -j$(nproc)
        else
          echo "No Makefile found; skipping make."
        fi

    - name: Test
      run: |
        if make -q check 2>/dev/null || [ -f Makefile ]; then
          make check || true
        else
          echo "No tests found or make check failed."
        fi

    - name: Distcheck
      run: |
        if [ -f Makefile ]; then
          make distcheck || true
        else
          echo "No Makefile found; skipping distcheck."
        fi
